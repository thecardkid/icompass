name: build-image
on:
  push:
    - master
jobs:
  webpack-build:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: '8.17.0'
      - shell: bash
        run: npm run build
        env:
          CI: true
          HOST: https://icompass.me
          S3_BUCKET: innovatorscompass
          NODE_ENV: production
          GA_TRACKING_ID: ${{ secrets.GA_TRACKING_ID }}
      - uses: actions/upload-artifact@v2
        with:
          name: website-dist
          path: backend/website-dist

  build-image:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/down-artifact@v2
        with:
          name: website-dist
          path: backend/website-dist
      - uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          tags: |
            thecardkid/icompass:github_actions_test
#            thecardkid/icompass:latest
#            thecardkid/icompass:
        secrets: |
          "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          "MONGODB_URI=${{ secrets.PROD_MONGODB_URI }}"
          "EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}"
        env:
          CI: true
          AWS_ACCESS_KEY_ID: AKIAJPWD7V6OQ3QKFUPA
          S3_BUCKET: innovatorscompassprod
          NODE_ENV: production
          HOST: https://icompass.me
